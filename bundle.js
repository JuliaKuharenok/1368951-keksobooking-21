(()=>{"use strict";window.load=function(e,t){const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},window.upload=function(e,t,n){const o=new XMLHttpRequest;o.resposeType="json",o.addEventListener("load",(function(){200===o.status?t(o.response):n("Статус ответа: "+o.status+" "+o.statusText)})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)},function(){const e="12:00",t="13:00",n="14:00",o="1000",i="5000",r="10000",a=document.querySelector(".ad-form"),c=a.querySelector("#room_number"),s=a.querySelector("#capacity"),d=a.querySelector("#timein"),u=a.querySelector("#timeout"),p=a.querySelector("#type"),l=a.querySelector("#price"),f=a.querySelector(".ad-form__reset"),m=document.querySelector("#success").content.querySelector(".success"),w=document.querySelector("#error").content.querySelector(".error"),y=function(){switch(c.value){case"1":if("1"!==s.value)return s.setCustomValidity("В одной комнате можно разместить не более одного гостя"),void s.reportValidity();break;case"2":if("0"===s.value||"3"===s.value)return s.setCustomValidity("В двух комнатах можно разместить не более двух гостей"),void s.reportValidity();break;case"3":if("0"===s.value)return s.setCustomValidity("В трех комнатах можно разместить до трех гостей"),void s.reportValidity();break;case"100":if("0"!==s.value)return s.setCustomValidity("Сто комнат не предназначены для гостей"),void s.reportValidity()}s.setCustomValidity("")};s.addEventListener("change",y),c.addEventListener("change",y),d.addEventListener("change",(function(){switch(d.value){case e:u.value=e;break;case t:u.value=t;break;case n:u.value=n}})),p.addEventListener("change",(function(){switch(p.value){case"bungalow":l.min="0",l.placeholder="0";break;case"flat":l.min=o,l.placeholder=o;break;case"house":l.min=i,l.placeholder=i;break;case"palace":l.min=r,l.placeholder=r}})),f.addEventListener("click",(function(){window.page.getPageDisabled()}));const h=function(e){document.addEventListener("click",(function(){window.pins.map.removeChild(e)}),{once:!0}),document.addEventListener("keydown",(function(t){"Escape"===t.key&&window.pins.map.removeChild(e)}),{once:!0})},v=function(){window.page.getPageDisabled();const e=m.cloneNode(!0);window.pins.map.appendChild(e),h(e)},_=function(){const e=w.cloneNode(!0);window.pins.map.appendChild(e),h(e)};a.addEventListener("submit",(function(e){e.preventDefault(),window.upload(new FormData(a),v,_)})),window.form={advertismentForm:a,errorHendler:_,errorMessageTemplate:w,removeMessage:h}}(),function(){let e,t,n,o,i=[],r=[];const a=document.querySelector("#housing-type"),c=document.querySelector("#housing-price"),s=document.querySelector("#housing-rooms"),d=document.querySelector("#housing-guests"),u=document.querySelectorAll(".map__checkbox"),p=function(i){let a=0;switch(i.offer.type===e&&(a+=5),t){case"low":i.offer.price<1e4&&(a+=4);break;case"high":i.offer.price>5e4&&(a+=4);break;case"middle":i.offer.price>=1e4&&i.offer.price<=5e4&&(a+=4)}return i.offer.rooms===n&&(a+=3),i.offer.guests===o&&(a+=2),i.offer.features.forEach((function(e){r.forEach((function(t){e===t&&(a+=1)}))})),a},l=function(){window.pins.removePins(),window.pins.showPins(i.sort((function(e,t){return p(t)-p(e)})))};a.addEventListener("change",(function(){e=a.value,l()})),s.addEventListener("change",(function(){n=Number(s.value),l()})),d.addEventListener("change",(function(){o=Number(d.value),l()})),c.addEventListener("change",(function(){t=c.value,l()}));for(let e=0;e<u.length;e++)u[e].addEventListener("change",(function(){u[e].checked&&r.push(u[e].value),l()}));window.filters={checkbox:u,errorHendler:function(){const e=window.form.errorMessageTemplate.cloneNode(!0);e.querySelector(".error__message").textContent="Ошибка соеденинения",window.pins.map.appendChild(e),window.form.removeMessage(e)},successHandler:function(e){i=e,l()}}}(),function(){const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),n=e.querySelector(".map__pin--main"),o=document.querySelector("#pin").content.querySelector(".map__pin"),i=e.querySelector(".map__pin--main").offsetWidth/2,r=e.querySelector(".map__pin--main").offsetHeight,a=e.querySelector(".map__pin").offsetWidth/2,c=e.querySelector(".map__pin").offsetHeight;let s=570;document.documentElement.clientWidth<1200&&(s=Math.round(document.documentElement.clientWidth/2-i)),n.addEventListener("mousedown",(function(e){if(1===e.which){e.preventDefault();let t={x:e.clientX,y:e.clientY};const o=function(e){e.preventDefault();const o=t.x-e.clientX,i=t.y-e.clientY;t={x:e.clientX,y:e.clientY},n.style.top=n.offsetTop-i+"px",n.style.left=n.offsetLeft-o+"px",t.x<120&&(n.style.left="0px"),t.x>1140&&(n.style.left="1140px"),t.y<130&&(n.style.top="130px"),t.y>630&&(n.style.top="630px")},i=function(e){e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i),window.page.getPageActive()};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)}})),window.pins={map:e,pins:t,mainPin:n,mainPinLeft:s,MAIN_PIN_TOP:375,xShiftMain:i,yShiftMain:r,xShift:a,yShift:c,renderPin:function(e){const t=o.cloneNode(!0);return t.style.left=e.location.x+a+"px",t.style.top=e.location.y+c+"px",t.querySelector("img").src=e.author.avatar,t.querySelector("img").alt=e.offer.title,t.addEventListener("click",(function(){t.classList.add("map__pin--active"),window.card.getAdvertismentCard(e)})),t.addEventListener("keydown",(function(n){"Enter"===n.key&&(t.classList.add("map__pin--active"),window.card.getAdvertismentCard(e))})),t},showPins:function(e){const n=document.createDocumentFragment();for(let t=0;t<5;t++)n.appendChild(window.pins.renderPin(e[t]));t.appendChild(n)},removePins:function(){window.pins.map.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){t.removeChild(e)}))}}}(),function(){const e=document.querySelector("#card").content.querySelector(".popup"),t=document.createDocumentFragment(),n=function(e){e.classList.add("hidden"),document.querySelector(".map__pin--active")&&document.querySelector(".map__pin--active").classList.remove("map__pin--active")};window.card={getAdvertismentCard:function(o){window.pins.map.querySelectorAll(".map__card").forEach((function(e){n(e)})),t.appendChild(function(t){const o=e.cloneNode(!0);return o.querySelector(".popup__title").textContent=t.offer.title,o.querySelector(".popup__text--address").textContent=t.offer.address,o.querySelector(".popup__text--price").textContent=t.offer.price,o.querySelector(".popup__type").textContent=t.offer.type,o.querySelector(".popup__text--capacity").textContent=t.offer.rooms+" комнаты для "+t.offer.guests+" гостей",0!==t.offer.rooms&&0!==t.offer.guests||o.querySelector(".popup__text--capacity").classList.add("hidden"),o.querySelector(".popup__text--time").textContent="Заезд после "+t.offer.checkin+", выезд до "+t.offer.checkout,function(e,t){const n=e.querySelectorAll(".popup__feature"),o=t.offer.features;n.forEach((function(e){e.classList.add("hidden")})),o.forEach((function(t){const n=document.createElement("li");n.className="popup__feature popup__feature--"+t,e.querySelector(".popup__features").appendChild(n)}))}(o,t),o.querySelector(".popup__description").textContent=t.offer.description,function(e,t){if(0===t.offer.photos.length)e.querySelector(".popup__photo").classList.add("hidden");else{e.querySelector(".popup__photo").src=t.offer.photos[0];for(let n=1;n<t.offer.photos.length;n++){const o=document.createElement("img");o.className="popup__photo",o.src=t.offer.photos[n],o.width="45",o.height="40",o.alt="Фотография жилья",e.querySelector(".popup__photos").appendChild(o)}}}(o,t),o.querySelector(".popup__avatar").src=t.author.avatar,o.querySelector(".popup__close").addEventListener("click",(function(){n(o)})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&n(o)}),{once:!0}),o}(o)),window.pins.pins.appendChild(t)},removeAdvertismentCard:n}}(),function(){const e=window.form.advertismentForm.querySelector(".ad-form-header"),t=window.form.advertismentForm.querySelectorAll(".ad-form__element"),n=window.form.advertismentForm.querySelector("#address"),o=document.querySelector(".map__filters"),i=o.querySelectorAll(".map__filter"),r=function(){window.pins.map.classList.add("map--faded"),window.form.advertismentForm.classList.add("ad-form--disabled"),window.form.advertismentForm.reset(),o.reset(),e.setAttribute("disabled","disabled"),t.forEach((function(e){e.setAttribute("disabled","disabled")})),i.forEach((function(e){e.setAttribute("disabled","disabled")})),window.filters.checkbox.forEach((function(e){e.setAttribute("disabled","disabled")})),window.pins.mainPin.style.left=window.pins.mainPinLeft+"px",window.pins.mainPin.style.top=window.pins.MAIN_PIN_TOP+"px",n.value=window.pins.mainPinLeft+" , "+window.pins.MAIN_PIN_TOP,window.pins.removePins(),window.pins.map.querySelector(".map__card")&&window.card.removeAdvertismentCard(window.pins.map.querySelector(".map__card"))};r(),window.page={getPageActive:function(){window.pins.map.classList.remove("map--faded"),window.form.advertismentForm.classList.remove("ad-form--disabled"),e.removeAttribute("disabled"),t.forEach((function(e){e.removeAttribute("disabled")})),i.forEach((function(e){e.removeAttribute("disabled")})),window.filters.checkbox.forEach((function(e){e.removeAttribute("disabled")})),n.value=Math.round(window.pins.mainPin.offsetLeft+window.pins.xShiftMain)+" , "+(window.pins.mainPin.offsetTop+window.pins.yShiftMain),window.load(window.filters.successHandler,window.filters.errorHendler)},getPageDisabled:r}}()})();