(()=>{"use strict";window.load=function(e,t){const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},window.upload=function(e,t,n){const o=new XMLHttpRequest;o.resposeType="json",o.addEventListener("load",(function(){200===o.status?t(o.response):n("Статус ответа: "+o.status+" "+o.statusText)})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)},function(){const e="12:00",t="13:00",n="14:00",o="1000",i="5000",r="10000",a=document.querySelector(".ad-form"),s=a.querySelector("#room_number"),c=a.querySelector("#capacity"),d=a.querySelector("#timein"),u=a.querySelector("#timeout"),l=a.querySelector("#type"),p=a.querySelector("#price"),f=a.querySelector(".ad-form__reset"),m=document.querySelector("#success").content.querySelector(".success"),w=document.querySelector("#error").content.querySelector(".error"),v=function(){switch(s.value){case"1":if("1"!==c.value)return c.setCustomValidity("В одной комнате можно разместить не более одного гостя"),void c.reportValidity();break;case"2":if("0"===c.value||"3"===c.value)return c.setCustomValidity("В двух комнатах можно разместить не более двух гостей"),void c.reportValidity();break;case"3":if("0"===c.value)return c.setCustomValidity("В трех комнатах можно разместить до трех гостей"),void c.reportValidity();break;case"100":if("0"!==c.value)return c.setCustomValidity("Сто комнат не предназначены для гостей"),void c.reportValidity()}c.setCustomValidity("")};c.addEventListener("change",v),s.addEventListener("change",v),d.addEventListener("change",(function(){switch(d.value){case e:u.value=e;break;case t:u.value=t;break;case n:u.value=n}})),l.addEventListener("change",(function(){switch(l.value){case"bungalow":p.min="0",p.placeholder="0";break;case"flat":p.min=o,p.placeholder=o;break;case"house":p.min=i,p.placeholder=i;break;case"palace":p.min=r,p.placeholder=r}}));const y=function(){switch(l.value){case"bungalow":if(p.value<0)return p.setCustomValidity("Цена не может быть меньше 0"),void p.reportValidity();break;case"flat":if(p.value<1e3)return p.setCustomValidity("Цена должна быть больше или равна 1000"),void p.reportValidity();break;case"house":if(p.value<5e3)return p.setCustomValidity("Цена должна быть больше или равна 5000"),void p.reportValidity();break;case"palace":if(p.value<1e4)return p.setCustomValidity("Цена должна быть больше или равна 10000"),void p.reportValidity()}p.setCustomValidity("")};p.addEventListener("input",y),l.addEventListener("change",y),f.addEventListener("click",(function(){window.page.getPageDisabled()}));const h=function(e){document.addEventListener("click",(function(){window.pins.map.removeChild(e)}),{once:!0}),document.addEventListener("keydown",(function(t){"Escape"===t.key&&window.pins.map.removeChild(e)}),{once:!0})},_=function(){window.page.getPageDisabled();const e=m.cloneNode(!0);window.pins.map.appendChild(e),h(e)},g=function(){const e=w.cloneNode(!0);window.pins.map.appendChild(e),h(e)};a.addEventListener("submit",(function(e){e.preventDefault(),window.upload(new FormData(a),_,g)})),window.form={advertismentForm:a,errorHendler:g,errorMessageTemplate:w,removeMessage:h}}(),function(){let e,t,n,o,i=[],r=[];const a=document.querySelector("#housing-type"),s=document.querySelector("#housing-price"),c=document.querySelector("#housing-rooms"),d=document.querySelector("#housing-guests"),u=document.querySelectorAll(".map__checkbox"),l=function(i){let a=0;switch(i.offer.type===e&&(a+=5),t){case"low":i.offer.price<1e4&&(a+=4);break;case"high":i.offer.price>5e4&&(a+=4);break;case"middle":i.offer.price>=1e4&&i.offer.price<=5e4&&(a+=4)}return i.offer.rooms===n&&(a+=3),i.offer.guests===o&&(a+=2),i.offer.features.forEach((function(e){r.forEach((function(t){e===t&&(a+=1)}))})),a};let p=[];const f=function(){document.querySelector(".map__card")&&window.card.removeAdvertismentCard(document.querySelector(".map__card")),window.pins.removePins(),i=i.sort((function(e,t){return l(t)-l(e)})),p=[],p.push(i[0]);for(let e=1;e<i.length;e++)l(i[0])===l(i[e])&&p.push(i[e]);window.pins.showPins(p)};a.addEventListener("change",(function(){e=a.value,f()})),c.addEventListener("change",(function(){n=Number(c.value),f()})),d.addEventListener("change",(function(){o=Number(d.value),f()})),s.addEventListener("change",(function(){t=s.value,f()}));for(let e=0;e<u.length;e++)u[e].addEventListener("change",(function(){u[e].checked&&r.push(u[e].value),f()}));window.filters={checkbox:u,errorHendler:function(){const e=window.form.errorMessageTemplate.cloneNode(!0);e.querySelector(".error__message").textContent="Ошибка соеденинения",window.pins.map.appendChild(e),window.form.removeMessage(e)},successHandler:function(e){i=e,f()}}}(),function(){const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),n=e.querySelector(".map__pin--main"),o=document.querySelector("#pin").content.querySelector(".map__pin"),i=e.querySelector(".map__pin--main").offsetWidth/2,r=e.querySelector(".map__pin--main").offsetHeight,a=e.querySelector(".map__pin").offsetWidth/2,s=e.querySelector(".map__pin").offsetHeight;let c=570,d=5;document.documentElement.clientWidth<1200&&(c=Math.round(document.documentElement.clientWidth/2-i)),n.addEventListener("mousedown",(function(t){if(1===t.which){t.preventDefault();let o={x:t.clientX,y:t.clientY};const a=function(t){t.preventDefault();const a=window.pageYOffset,s=e.getBoundingClientRect(),c=o.x-t.clientX,d=o.y-t.clientY;o={x:t.clientX,y:t.clientY},n.style.top=n.offsetTop-d+"px",n.style.left=n.offsetLeft-c+"px",o.x<s.left&&(n.style.left=0-i+"px"),o.x>s.right&&(n.style.left=1200-i+"px"),o.y<130-a&&(n.style.top=130-r+"px"),o.y>630-a&&(n.style.top=630-r+"px")},s=function(e){e.preventDefault(),window.page.updateAddress(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",s)};window.page.getPageActive(),document.addEventListener("mousemove",a),document.addEventListener("mouseup",s)}})),window.pins={map:e,pins:t,mainPin:n,mainPinLeft:c,MAIN_PIN_TOP:375,xShiftMain:i,yShiftMain:r,xShift:a,yShift:s,renderPin:function(e){const t=o.cloneNode(!0);return t.style.left=e.location.x-a+"px",t.style.top=e.location.y-s+"px",t.querySelector("img").src=e.author.avatar,t.querySelector("img").alt=e.offer.title,t.addEventListener("click",(function(){const n=window.pins.map.querySelector(".map__card");n&&window.card.removeAdvertismentCard(n),window.card.getAdvertismentCard(e),t.classList.add("map__pin--active")})),t.addEventListener("keydown",(function(n){"Enter"===n.key&&(t.classList.add("map__pin--active"),window.card.getAdvertismentCard(e))})),t},showPins:function(e){const n=document.createDocumentFragment();for(let t=0;t<((o=e).length<5&&(d=o.length),d);t++)n.appendChild(window.pins.renderPin(e[t]));var o;t.appendChild(n)},removePins:function(){window.pins.map.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){t.removeChild(e)}))}}}(),function(){const e=document.querySelector("#card").content.querySelector(".popup"),t=document.createDocumentFragment(),n=function(e){window.pins.pins.removeChild(e),document.querySelector(".map__pin--active")&&document.querySelector(".map__pin--active").classList.remove("map__pin--active")};window.card={getAdvertismentCard:function(o){t.appendChild(function(t){const o=e.cloneNode(!0);o.querySelector(".popup__title").textContent=t.offer.title,o.querySelector(".popup__text--address").textContent=t.offer.address,o.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",o.querySelector(".popup__type").textContent=t.offer.type,o.querySelector(".popup__text--capacity").textContent=t.offer.rooms+" комнаты для "+t.offer.guests+" гостей",0!==t.offer.rooms&&0!==t.offer.guests||o.querySelector(".popup__text--capacity").classList.add("hidden"),o.querySelector(".popup__text--time").textContent="Заезд после "+t.offer.checkin+", выезд до "+t.offer.checkout,function(e,t){const n=e.querySelectorAll(".popup__feature"),o=t.offer.features;n.forEach((function(e){e.classList.add("hidden")})),o.forEach((function(t){const n=document.createElement("li");n.className="popup__feature popup__feature--"+t,e.querySelector(".popup__features").appendChild(n)}))}(o,t),o.querySelector(".popup__description").textContent=t.offer.description,function(e,t){if(0===t.offer.photos.length)e.querySelector(".popup__photo").classList.add("hidden");else{e.querySelector(".popup__photo").src=t.offer.photos[0];for(let n=1;n<t.offer.photos.length;n++){const o=document.createElement("img");o.className="popup__photo",o.src=t.offer.photos[n],o.width="45",o.height="40",o.alt="Фотография жилья",e.querySelector(".popup__photos").appendChild(o)}}}(o,t);const i=function(e){"Escape"===e.key&&n(o)};return o.querySelector(".popup__avatar").src=t.author.avatar,document.addEventListener("keydown",i,{once:!0}),o.querySelector(".popup__close").addEventListener("click",(function(){n(o),document.removeEventListener("keydown",i)})),o}(o)),window.pins.pins.appendChild(t)},removeAdvertismentCard:n}}(),function(){const e=window.form.advertismentForm.querySelector(".ad-form-header"),t=window.form.advertismentForm.querySelectorAll(".ad-form__element"),n=window.form.advertismentForm.querySelector("#address"),o=document.querySelector(".map__filters"),i=o.querySelectorAll(".map__filter"),r=function(){window.pins.map.classList.add("map--faded"),window.form.advertismentForm.classList.add("ad-form--disabled"),window.form.advertismentForm.reset(),o.reset(),e.setAttribute("disabled","disabled"),t.forEach((function(e){e.setAttribute("disabled","disabled")})),i.forEach((function(e){e.setAttribute("disabled","disabled")})),window.filters.checkbox.forEach((function(e){e.setAttribute("disabled","disabled")})),window.pins.mainPin.style.left=window.pins.mainPinLeft+"px",window.pins.mainPin.style.top=window.pins.MAIN_PIN_TOP+"px",n.value=window.pins.mainPinLeft+" , "+window.pins.MAIN_PIN_TOP,window.pins.removePins(),window.pins.map.querySelector(".map__card")&&window.card.removeAdvertismentCard(window.pins.map.querySelector(".map__card"))};r(),window.page={getPageActive:function(){window.pins.map.classList.remove("map--faded"),window.form.advertismentForm.classList.remove("ad-form--disabled"),e.removeAttribute("disabled"),t.forEach((function(e){e.removeAttribute("disabled")})),i.forEach((function(e){e.removeAttribute("disabled")})),window.filters.checkbox.forEach((function(e){e.removeAttribute("disabled")})),window.load(window.filters.successHandler,window.filters.errorHendler)},getPageDisabled:r,updateAddress:function(){n.value=Math.floor(window.pins.mainPin.offsetLeft+window.pins.xShiftMain)+" , "+(window.pins.mainPin.offsetTop+window.pins.yShiftMain)}}}()})();